---
import BaseLayout from '@/layouts/BaseLayout.astro';
import SEOHead from '@/components/SEOHead.astro';
import BreadcrumbSchema from '@/components/schemas/BreadcrumbSchema.astro';
import { BaseCrudService } from '@/integrations';
import type { BlogArticles } from '@/entities';

// Fetch blog articles server-side
let articles: BlogArticles[] = [];
try {
  const data = await BaseCrudService.getAll<BlogArticles>('blogarticles');
  articles = data.items.sort((a, b) => {
    const dateA = a.publishDate ? new Date(a.publishDate).getTime() : 0;
    const dateB = b.publishDate ? new Date(b.publishDate).getTime() : 0;
    return dateB - dateA;
  });
} catch (e) {
  console.error('Failed to fetch blog articles:', e);
}

const breadcrumbs = [
  { name: 'Home', url: 'https://www.nik.finance/' },
  { name: 'Blog', url: 'https://www.nik.finance/blog' },
];

// Extract unique categories from articles
const categories = [...new Set(articles.map(a => a.category).filter(Boolean))] as string[];

// Helper to estimate read time from content
function getReadTime(content?: string): number {
  if (!content) return 3;
  const wordCount = content.replace(/<[^>]*>/g, '').split(/\s+/).filter(Boolean).length;
  return Math.max(1, Math.ceil(wordCount / 200));
}

// Helper to format date
function formatDate(date?: Date | string): string {
  if (!date) return '';
  const d = new Date(date);
  return d.toLocaleDateString('en-AU', { day: 'numeric', month: 'long', year: 'numeric' });
}
---

<BaseLayout>
  <Fragment slot="seo">
    <SEOHead
      title="Finance Blog | Expert Tips & Guides"
      description="Expert finance articles covering home loans, car finance, personal loans, and business finance in Australia. Tips, guides, and insights from the NIK Finance team."
      keywords="finance blog, home loan tips, car loan guide, personal loan advice, business finance Australia, mortgage tips, refinancing guide, loan comparison"
      canonical="https://www.nik.finance/blog"
    />
  </Fragment>
  <Fragment slot="schema">
    <BreadcrumbSchema items={breadcrumbs} />
  </Fragment>

  <!-- Hero Section -->
  <section class="relative bg-gradient-to-br from-[#0d4d3e] to-[#1e3a5f] py-20 md:py-28">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <h1 class="font-heading text-4xl md:text-5xl lg:text-6xl font-bold text-white mb-6">
        Finance Blog
      </h1>
      <p class="font-paragraph text-lg md:text-xl text-white/80 max-w-3xl mx-auto">
        Expert advice, tips, and guides on home loans, car finance, personal loans, and business finance in Australia. Stay informed and make smarter financial decisions.
      </p>
    </div>
  </section>

  <!-- Categories Navigation -->
  {categories.length > 0 && (
    <section class="py-6 bg-white border-b border-[#333333]/5">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <nav class="flex flex-wrap gap-3 justify-center">
          <a href="/blog" class="font-paragraph text-sm font-semibold px-4 py-2 rounded-full bg-[#0d4d3e] text-white transition-colors">
            All Articles
          </a>
          {categories.map((cat) => (
            <span class="font-paragraph text-sm font-semibold px-4 py-2 rounded-full bg-[#10b981]/10 text-[#0d4d3e] hover:bg-[#10b981]/20 transition-colors cursor-default">
              {cat}
            </span>
          ))}
        </nav>
      </div>
    </section>
  )}

  <!-- Blog Articles Grid -->
  <section class="py-16 md:py-24 bg-[#f8fafb]">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      {articles.length > 0 ? (
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
          {articles.map((article) => (
            <article class="bg-white rounded-3xl overflow-hidden border border-[#333333]/5 hover:shadow-lg transition-shadow duration-300 flex flex-col">
              <!-- Featured Image -->
              <a href={`/blog/${article.slug}`} class="block">
                {article.featuredImage ? (
                  <img
                    src={article.featuredImage}
                    alt={article.title || 'Blog article'}
                    class="w-full h-52 object-cover"
                    loading="lazy"
                  />
                ) : (
                  <div class="w-full h-52 bg-gradient-to-br from-[#0d4d3e]/10 to-[#10b981]/10 flex items-center justify-center">
                    <svg class="w-16 h-16 text-[#10b981]/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />
                    </svg>
                  </div>
                )}
              </a>

              <!-- Card Content -->
              <div class="p-6 flex flex-col flex-1">
                {/* Category Badge */}
                {article.category && (
                  <span class="inline-block self-start font-paragraph text-xs font-semibold uppercase tracking-wider text-[#10b981] bg-[#10b981]/10 px-3 py-1 rounded-full mb-3">
                    {article.category}
                  </span>
                )}

                {/* Title */}
                <h2 class="font-heading text-xl font-bold text-[#333333] mb-3 hover:text-[#0d4d3e] transition-colors">
                  <a href={`/blog/${article.slug}`} class="block">
                    {article.title}
                  </a>
                </h2>

                {/* Excerpt */}
                {article.excerpt && (
                  <p class="font-paragraph text-[#333333]/70 text-sm leading-relaxed mb-4 flex-1">
                    {article.excerpt}
                  </p>
                )}

                {/* Meta: Author, Date, Read Time */}
                <div class="flex items-center justify-between text-xs font-paragraph text-[#333333]/50 pt-4 border-t border-[#333333]/5 mt-auto">
                  <div class="flex items-center gap-3">
                    {article.author && (
                      <span class="flex items-center gap-1">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                        {article.author}
                      </span>
                    )}
                    {article.publishDate && (
                      <span class="flex items-center gap-1">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        {formatDate(article.publishDate)}
                      </span>
                    )}
                  </div>
                  <span class="flex items-center gap-1">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    {getReadTime(article.content)} min read
                  </span>
                </div>
              </div>
            </article>
          ))}
        </div>
      ) : (
        <div class="text-center py-16">
          <div class="w-20 h-20 mx-auto bg-[#10b981]/10 rounded-full flex items-center justify-center mb-6">
            <svg class="w-10 h-10 text-[#10b981]/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />
            </svg>
          </div>
          <h2 class="font-heading text-2xl font-bold text-[#333333] mb-3">No articles yet</h2>
          <p class="font-paragraph text-[#333333]/60 text-lg max-w-md mx-auto">
            We are working on fresh content. Check back soon for expert finance tips, guides, and insights.
          </p>
        </div>
      )}
    </div>
  </section>

  <!-- CTA Section -->
  <section class="py-16 md:py-24 bg-gradient-to-br from-[#0d4d3e] to-[#1e3a5f]">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <h2 class="font-heading text-3xl md:text-4xl font-bold text-white mb-6">
        Ready to find the right loan?
      </h2>
      <p class="font-paragraph text-lg text-white/80 max-w-2xl mx-auto mb-8">
        Let our AI match you with the best lenders for your situation. It is free, fast, and there is no obligation.
      </p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a
          href="https://app.middle.finance/ref/7d27aec6-deb1-4e44-8bd8-85f8f8aecff3"
          class="inline-flex items-center justify-center px-8 py-4 bg-[#10b981] text-white font-heading font-semibold rounded-2xl hover:bg-[#0d9668] transition-colors duration-200 text-lg"
        >
          Apply Now -- It's Free
        </a>
        <a
          href="/contact"
          class="inline-flex items-center justify-center px-8 py-4 bg-white text-[#0d4d3e] font-heading font-semibold rounded-2xl hover:bg-white/90 transition-colors duration-200 text-lg"
        >
          Contact Us
        </a>
      </div>
      <p class="font-paragraph text-sm text-white/40 mt-6">
        NIK Finance Pty Ltd (ACN 685 393 917) is a Credit Representative (No. 567387) of Finsure Finance & Insurance Pty Ltd (Australian Credit Licence 384704).
      </p>
    </div>
  </section>
</BaseLayout>
