---
import BaseLayout from '@/layouts/BaseLayout.astro';
import SEOHead from '@/components/SEOHead.astro';
import ArticleSchema from '@/components/schemas/ArticleSchema.astro';
import BreadcrumbSchema from '@/components/schemas/BreadcrumbSchema.astro';
import { BaseCrudService } from '@/integrations';
import type { BlogArticles } from '@/entities';

const { slug } = Astro.params;

// Fetch all articles and find by slug
let article: BlogArticles | null = null;
let relatedArticles: BlogArticles[] = [];
try {
  const data = await BaseCrudService.getAll<BlogArticles>('blogarticles');
  article = data.items.find(a => a.slug === slug) || null;
  if (article) {
    relatedArticles = data.items
      .filter(a => a._id !== article?._id && a.category === article?.category)
      .slice(0, 3);
  }
} catch (e) {
  console.error('Failed to fetch article:', e);
}

if (!article) {
  return Astro.redirect('/blog');
}

// Helper to estimate read time from content
function getReadTime(content?: string): number {
  if (!content) return 3;
  const wordCount = content.replace(/<[^>]*>/g, '').split(/\s+/).filter(Boolean).length;
  return Math.max(1, Math.ceil(wordCount / 200));
}

// Helper to format date
function formatDate(date?: Date | string): string {
  if (!date) return '';
  const d = new Date(date);
  return d.toLocaleDateString('en-AU', { day: 'numeric', month: 'long', year: 'numeric' });
}

// Helper to format ISO date for meta tags
function toISODate(date?: Date | string): string {
  if (!date) return '';
  return new Date(date).toISOString();
}

const readTime = getReadTime(article.content);
const articleUrl = `https://www.nik.finance/blog/${article.slug}`;

const breadcrumbs = [
  { name: 'Home', url: 'https://www.nik.finance/' },
  { name: 'Blog', url: 'https://www.nik.finance/blog' },
  { name: article.title || 'Article', url: articleUrl },
];
---

<BaseLayout>
  <Fragment slot="seo">
    <SEOHead
      title={article.seoTitle || article.title || 'Blog Article'}
      description={article.seoDescription || article.excerpt || 'Read this finance article from NIK Finance.'}
      keywords={`${article.category || 'finance'}, ${article.title || ''}, NIK Finance blog, Australian finance`}
      canonical={articleUrl}
      ogImage={article.featuredImage}
      type="article"
      publishedTime={article.publishDate ? toISODate(article.publishDate) : undefined}
      modifiedTime={article._updatedDate ? toISODate(article._updatedDate) : undefined}
      author={article.author || 'NIK Finance Team'}
      section={article.category}
    />
  </Fragment>
  <Fragment slot="schema">
    <ArticleSchema
      title={article.title || 'Blog Article'}
      description={article.seoDescription || article.excerpt || ''}
      url={articleUrl}
      image={article.featuredImage}
      datePublished={article.publishDate ? toISODate(article.publishDate) : undefined}
      dateModified={article._updatedDate ? toISODate(article._updatedDate) : undefined}
      author={article.author || 'NIK Finance Team'}
      section={article.category}
      keywords={`${article.category || 'finance'}, ${article.title || ''}`}
    />
    <BreadcrumbSchema items={breadcrumbs} />
  </Fragment>

  <!-- Article Header -->
  <section class="relative bg-gradient-to-br from-[#0d4d3e] to-[#1e3a5f] py-16 md:py-24">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      {/* Breadcrumb Navigation */}
      <nav class="mb-8">
        <ol class="flex items-center justify-center gap-2 font-paragraph text-sm text-white/60">
          <li>
            <a href="/" class="hover:text-white transition-colors">Home</a>
          </li>
          <li class="flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
            <a href="/blog" class="hover:text-white transition-colors">Blog</a>
          </li>
          <li class="flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
            <span class="text-white/80 truncate max-w-[200px]">{article.title}</span>
          </li>
        </ol>
      </nav>

      {/* Category Badge */}
      {article.category && (
        <span class="inline-block font-paragraph text-xs font-semibold uppercase tracking-wider text-[#10b981] bg-white/10 px-4 py-1.5 rounded-full mb-6">
          {article.category}
        </span>
      )}

      {/* Title */}
      <h1 class="font-heading text-3xl md:text-4xl lg:text-5xl font-bold text-white mb-6 leading-tight">
        {article.title}
      </h1>

      {/* Article Meta */}
      <div class="flex items-center justify-center gap-4 md:gap-6 font-paragraph text-sm text-white/60 flex-wrap">
        {article.author && (
          <span class="flex items-center gap-1.5">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
            {article.author}
          </span>
        )}
        {article.publishDate && (
          <span class="flex items-center gap-1.5">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
            {formatDate(article.publishDate)}
          </span>
        )}
        <span class="flex items-center gap-1.5">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
          {readTime} min read
        </span>
      </div>
    </div>
  </section>

  <!-- Featured Image -->
  {article.featuredImage && (
    <section class="bg-white">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 -mt-8">
        <img
          src={article.featuredImage}
          alt={article.title || 'Article featured image'}
          class="w-full rounded-3xl shadow-lg object-cover max-h-[480px]"
        />
      </div>
    </section>
  )}

  <!-- Article Content -->
  <section class="py-12 md:py-16 bg-white">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
      <div
        class="article-content font-paragraph text-[#333333]/85 text-lg leading-relaxed
          [&>h2]:font-heading [&>h2]:text-2xl [&>h2]:md:text-3xl [&>h2]:font-bold [&>h2]:text-[#333333] [&>h2]:mt-10 [&>h2]:mb-4
          [&>h3]:font-heading [&>h3]:text-xl [&>h3]:md:text-2xl [&>h3]:font-semibold [&>h3]:text-[#333333] [&>h3]:mt-8 [&>h3]:mb-3
          [&>h4]:font-heading [&>h4]:text-lg [&>h4]:font-semibold [&>h4]:text-[#333333] [&>h4]:mt-6 [&>h4]:mb-2
          [&>p]:mb-5
          [&>ul]:list-disc [&>ul]:pl-6 [&>ul]:mb-5 [&>ul]:space-y-2
          [&>ol]:list-decimal [&>ol]:pl-6 [&>ol]:mb-5 [&>ol]:space-y-2
          [&>blockquote]:border-l-4 [&>blockquote]:border-[#10b981] [&>blockquote]:pl-6 [&>blockquote]:py-2 [&>blockquote]:my-6 [&>blockquote]:italic [&>blockquote]:text-[#333333]/70
          [&>a]:text-[#10b981] [&>a]:underline [&>a]:hover:text-[#0d9668]
          [&>img]:rounded-2xl [&>img]:my-6 [&>img]:mx-auto
          [&>table]:w-full [&>table]:my-6 [&>table]:border-collapse [&>table_th]:bg-[#f8fafb] [&>table_th]:p-3 [&>table_th]:text-left [&>table_th]:font-heading [&>table_th]:font-semibold [&>table_td]:p-3 [&>table_td]:border-t [&>table_td]:border-[#333333]/10
          [&_a]:text-[#10b981] [&_a]:underline [&_a]:hover:text-[#0d9668]"
        set:html={article.content || ''}
      />
    </div>
  </section>

  <!-- Share & Author Section -->
  <section class="py-12 md:py-16 bg-[#f8fafb]">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
      {/* Author Bio */}
      <div class="bg-white rounded-3xl p-8 border border-[#333333]/5">
        <div class="flex flex-col sm:flex-row items-center sm:items-start gap-6">
          <div class="w-20 h-20 flex-shrink-0 bg-gradient-to-br from-[#0d4d3e] to-[#10b981] rounded-full flex items-center justify-center">
            <span class="font-heading text-2xl font-bold text-white">
              {(article.author || 'NF').split(' ').map(n => n[0]).join('').slice(0, 2).toUpperCase()}
            </span>
          </div>
          <div class="text-center sm:text-left">
            <p class="font-paragraph text-xs font-semibold uppercase tracking-wider text-[#10b981] mb-1">Written by</p>
            <h3 class="font-heading text-xl font-bold text-[#333333] mb-2">
              {article.author || 'NIK Finance Team'}
            </h3>
            <p class="font-paragraph text-[#333333]/70 text-sm leading-relaxed mb-3">
              The NIK Finance team is dedicated to helping Australians make smarter financial decisions. With access to over 130 lenders and AI-powered matching, we provide expert guidance on home loans, car finance, personal loans, and business finance.
            </p>
            <a href="/about" class="font-paragraph text-sm text-[#10b981] hover:text-[#0d9668] font-semibold underline">
              Learn more about our team
            </a>
          </div>
        </div>
      </div>

      {/* Share Note */}
      <div class="mt-8 text-center">
        <p class="font-paragraph text-sm text-[#333333]/50">
          Found this article helpful? Share it with someone who might benefit from this information.
        </p>
      </div>
    </div>
  </section>

  <!-- Related Articles -->
  {relatedArticles.length > 0 && (
    <section class="py-16 md:py-24 bg-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
          <p class="font-paragraph text-sm font-semibold uppercase tracking-wider text-[#10b981] mb-3">Keep Reading</p>
          <h2 class="font-heading text-3xl md:text-4xl font-bold text-[#333333]">
            Related Articles
          </h2>
        </div>
        <div class="grid md:grid-cols-3 gap-8">
          {relatedArticles.map((related) => (
            <article class="bg-[#f8fafb] rounded-3xl overflow-hidden border border-[#333333]/5 hover:shadow-lg transition-shadow duration-300 flex flex-col">
              <a href={`/blog/${related.slug}`} class="block">
                {related.featuredImage ? (
                  <img
                    src={related.featuredImage}
                    alt={related.title || 'Related article'}
                    class="w-full h-44 object-cover"
                    loading="lazy"
                  />
                ) : (
                  <div class="w-full h-44 bg-gradient-to-br from-[#0d4d3e]/10 to-[#10b981]/10 flex items-center justify-center">
                    <svg class="w-12 h-12 text-[#10b981]/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />
                    </svg>
                  </div>
                )}
              </a>
              <div class="p-6 flex flex-col flex-1">
                {related.category && (
                  <span class="inline-block self-start font-paragraph text-xs font-semibold uppercase tracking-wider text-[#10b981] bg-[#10b981]/10 px-3 py-1 rounded-full mb-3">
                    {related.category}
                  </span>
                )}
                <h3 class="font-heading text-lg font-bold text-[#333333] mb-2 hover:text-[#0d4d3e] transition-colors">
                  <a href={`/blog/${related.slug}`} class="block">
                    {related.title}
                  </a>
                </h3>
                {related.excerpt && (
                  <p class="font-paragraph text-sm text-[#333333]/70 leading-relaxed flex-1">
                    {related.excerpt.length > 120 ? related.excerpt.slice(0, 120) + '...' : related.excerpt}
                  </p>
                )}
                <div class="flex items-center gap-3 text-xs font-paragraph text-[#333333]/50 mt-4 pt-3 border-t border-[#333333]/5">
                  {related.publishDate && (
                    <span>{formatDate(related.publishDate)}</span>
                  )}
                  <span>{getReadTime(related.content)} min read</span>
                </div>
              </div>
            </article>
          ))}
        </div>
        <div class="text-center mt-10">
          <a
            href="/blog"
            class="inline-flex items-center gap-2 font-heading font-semibold text-[#0d4d3e] hover:text-[#10b981] transition-colors"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
            Back to all articles
          </a>
        </div>
      </div>
    </section>
  )}

  <!-- CTA Section -->
  <section class="py-16 md:py-24 bg-gradient-to-br from-[#0d4d3e] to-[#1e3a5f]">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <h2 class="font-heading text-3xl md:text-4xl font-bold text-white mb-6">
        Need help with your finances?
      </h2>
      <p class="font-paragraph text-lg text-white/80 max-w-2xl mx-auto mb-8">
        Our AI-powered platform matches you with the best lenders from over 130 options. Free service, fast approval, and expert guidance every step of the way.
      </p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a
          href="https://app.middle.finance/ref/7d27aec6-deb1-4e44-8bd8-85f8f8aecff3"
          class="inline-flex items-center justify-center px-8 py-4 bg-[#10b981] text-white font-heading font-semibold rounded-2xl hover:bg-[#0d9668] transition-colors duration-200 text-lg"
        >
          Apply Now -- It's Free
        </a>
        <a
          href="/contact"
          class="inline-flex items-center justify-center px-8 py-4 bg-white text-[#0d4d3e] font-heading font-semibold rounded-2xl hover:bg-white/90 transition-colors duration-200 text-lg"
        >
          Contact Us
        </a>
      </div>
      <p class="font-paragraph text-sm text-white/40 mt-6">
        NIK Finance Pty Ltd (ACN 685 393 917) is a Credit Representative (No. 567387) of Finsure Finance & Insurance Pty Ltd (Australian Credit Licence 384704).
      </p>
    </div>
  </section>
</BaseLayout>
